# yaml-language-server: $schema=https://goreleaser.com/static/schema.json
version: 2

dist: ./dist/goreleaser

builds:
  - id: standard-backups
    binary: standard-backups
    main: ./cmd/standard-backups
    env:
      - CGO_ENABLED=0
    goos:
      - linux
  - id: standard-backups-restic-backend
    binary: standard-backups-restic-backend
    main: ./cmd/standard-backups-restic-backend
    env:
      - CGO_ENABLED=0
    goos:
      - linux
  - id: standard-backups-rsync-backend
    binary: standard-backups-rsync-backend
    main: ./cmd/standard-backups-rsync-backend
    env:
      - CGO_ENABLED=0
    goos:
      - linux

archives:
  - &archive-base
    id: standard-backups
    ids: [standard-backups]
    formats: [tar.gz]
    files:
      - LICENSE
      - README.md
      - src: examples/config.yaml
        dst: config.yaml
    name_template: &name-template >-
      {{ .Binary }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}
      {{- with .Arm }}v{{ . }}{{ end }}
      {{- with .Mips }}_{{ . }}{{ end }}
      {{- if not (eq .Amd64 "v1") }}{{ .Amd64 }}{{ end }}
  - <<: *archive-base
    id: standard-backups-restic-backend
    ids: [standard-backups-restic-backend]
    files:
      - LICENSE
      - src: ./cmd/standard-backups-restic-backend/restic.yaml
        dst: restic.yaml
  - <<: *archive-base
    id: standard-backups-rsync-backend
    ids: [standard-backups-rsync-backend]
    files:
      - LICENSE
      - src: ./cmd/standard-backups-rsync-backend/rsync.yaml
        dst: rsync.yaml

nfpms:
  - &npfm-base
    id: standard-backups
    ids: [standard-backups]
    package_name: standard-backups
    file_name_template: *name-template
    formats:
      - apk
      - deb
      - rpm
      - archlinux
    maintainer: Boris Bera <beraboris@gmail.com>
    contents:
      - src: LICENSE
        dst: /usr/share/doc/standard-backups/LICENSE
      - src: README.md
        dst: /usr/share/doc/standard-backups/README.md
      - src: examples/config.yaml
        dst: /etc/standard-backups/config.yaml
        type: config
  - <<: *npfm-base
    id: standard-backups-restic-backend
    ids: [standard-backups-restic-backend]
    package_name: standard-backups-restic-backend
    dependencies:
      - standard-backups
      - restic
    contents:
      - src: LICENSE
        dst: /usr/share/doc/standard-backups-restic-backend/LICENSE
      - src: ./cmd/standard-backups-restic-backend/restic.yaml
        dst: /usr/share/standard-backups/backends/restic.yaml
  - <<: *npfm-base
    id: standard-backups-rsync-backend
    ids: [standard-backups-rsync-backend]
    package_name: standard-backups-rsync-backend
    dependencies:
      - standard-backups
      - rsync
    contents:
      - src: LICENSE
        dst: /usr/share/doc/standard-backups-rsync-backend/LICENSE
      - src: ./cmd/standard-backups-rsync-backend/rsync.yaml
        dst: /usr/share/standard-backups/backends/rsync.yaml

changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
      - "^chore:"
